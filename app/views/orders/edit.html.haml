= render partial: 'shared/order_menu'
.order-form.edit
  %ul.nav.nav-tabs{id:"order-tabs"}
    %li.active
      %a{href:"#calc", data:{toggle:"tab"}} Калькулятор
    %li
      %a{href:"#loan", data:{toggle:"tab"}} Займ
    %li
      %a{href:"#borrower", data:{toggle:"tab"}} Заемщик
    %li
      %a{href:"#guarantors", data:{toggle:"tab"}} Поручители
    %li
      %a{href:"#documents", data:{toggle:"tab"}} Прикрепленные документы



  = simple_form_for @order, html:{multipart:true}, validation: true do |f|
    .tab-content{id:"tabs"}

      -# КАЛЬКУЛЯТОР #
      .tab-pane.fade.active.in{id:"calc"}
        .field-horizontal
          = f.fields_for :platform do |p|
            .field
              %label Площадка
              = p.select(:name, Tarif.uniq.pluck(:platform).map {|platform| [platform, platform, data:{number:platform}]})
          = f.fields_for :tarif do |p|
            .field.short
              %label Тариф
              = p.select(:name, Tarif.uniq.pluck(:type_t).map {|platform| [platform, platform, data:{number:platform}]})
        .field-horizontal.tarif
          %span.title.mfo_rate Ставка банка:
          %span.value.mfo_rate
          %span.title.agent_rate Ставка агента:
          %span.value.agent_rate 0%

        = simple_fields_for :service do |s|
          .calc.tender
            %h3 Тендерный
            .field-horizontal
              .field.short.offset-right
                %label Сумма займа
                = s.number_field :order_summa, value: params[:service] && params[:service][:order_summa] ? params[:service][:order_summa] : "0"
              .field.short
                %label Доход договора
                = s.input_field :dogovor_summa, value: params[:service] && params[:service][:dogovor_summa] ? params[:service][:dogovor_summa] : "0"
            .field-horizontal
              .field.short
                %label Доход МФО
                = s.input_field :mfo_summa, value: params[:service] && params[:service][:mfo_summa] ? params[:service][:mfo_summa] : "0"
              .field.small
                %label Ставка %
                = s.number_field :order_rate, value: params[:service] && params[:service][:order_rate] ? params[:service][:order_rate] : "0"
              .field.short
                %label Доход Агента
                = s.input_field :agent_summa, value: params[:service] && params[:service][:agent_summa] ? params[:service][:agent_summa] : "0"

          .calc.business.hidden
            %h3 Предпринимательский
            .field-horizontal
              .field
                %label Сумма займа
                = s.input_field :p_order_summa, value: params[:service] && params[:service][:p_order_summa] ? params[:service][:p_order_summa] : "0"
              .field
                %label Доход договора
                = s.input_field :p_dogovor_summa, value: params[:service] && params[:service][:p_order_summa] ? params[:service][:p_dogovor_summa] : "0"
            .field-horizontal
              .field.short
                %label Доход агента
                = s.input_field :p_agent_summa, disabled: true, value: params[:service] && params[:service][:p_agent_summa] ? params[:service][:p_agent_summa] : "0"
              .field.small
                %label Ставка %
                = s.input_field :p_order_rate, value: params[:service] && params[:service][:p_order_rate] ? params[:service][:p_order_rate] : "0"
              .field.short
                %label Доход МФО
                = s.input_field :p_mfo_summa, disabled: true, value: params[:service] && params[:service][:p_mfo_summa] ? params[:service][:p_mfo_summa] : "0"
      -# ЗАЯВКА #

      .tab-pane.fade{id:"loan"}
        .field
          %label Электронная площадка
          = f.input_field :platform
          = f.error :platform
        .field
          %label Сумма
          = f.input_field :summa
          = f.error :summa
        .field
          %label Крайний срок предоставления
          = f.date_field :submission_deadline
          = f.error :submission_deadline
        .field
          %label Агент
          = f.input_field :agent
          = f.error :agent
        .field
          %label АгентНаименование
          = f.input_field :agent_name
          = f.error :agent_name
        .field
          %label АгентВознаграждение
          = f.input_field :agent_summa
          = f.error :agent_summa
        .field
          %label МфоВознаграждение
          = f.input_field :mfo_summa
          = f.error :mfo_summa
        .field
          %label ДоговорВознаграждение
          = f.input_field :dogovor_summa
          = f.error :dogovor_summa
        .field.hidden
          %label Номер
          = f.input_field :number
          = f.error :number
        .field.hidden
          %label НомерМФО
          = f.input_field :number_mfo
          = f.error :number_mfo
        .field.hidden
          %label НомерДатаПротокола
          = f.input_field :number_data_protocol
          = f.error :number_data_protocol
        .field
          %label Лицевой счет
          = f.input_field :personal_number
          = f.error :personal_number
        .field
          %label Статус
          = f.input_field :status
          = f.error :status


      -# ОРГАНИЗАЦИЯ - ЗАЕМЩИК #

      .tab-pane.fade{id:"borrower"}
        = f.fields_for :borrower do |b|
          .field-group
            .field
              %label Укажите тип заемщика
              = b.select :type_o, [['Юридическое лицо', 'ЮЛ'] ,['Физическое лицо', 'ФЛ']]

          .field-group
            .field-horizontal
              .field.inn
                %label ИНН
                = b.input_field :inn
                = b.error :inn
              .field{class:"kpp #{'hidden' if @order.borrower.type_o == 'ФЛ'}"}
                %label КПП
                = b.input_field :kpp
                = b.error :kpp
            .field.button-right
              .indicator.hidden{id:'borrower-indicator'}
              %button.btn.btn-primary.check{type:'button',data:{targetform:'check-borrower'}} Искать в базе

          .field-group
            %h5.title Основные данные
            .field.long
              %label Название организации
              = b.input_field :name
              = b.error :name
            .field.long
              %label Полное название организации
              = b.input_field :fullname
              = b.error :fullname
            .field.long
              %label Юридический адрес
              = b.input_field :address_legal
              = b.error :address_legal
            .field.long
              %label Фактический адрес
              = b.input_field :address_actual
              = b.error :address_actual
            .field-horizontal
              .field
                %label Дата регистрации
                = b.date_field :reg_date
                = b.error :reg_date
              .field
                %label ОГРН
                = b.input_field :ogrn
                = b.error :ogrn
            .field
              %label Должность руководителя
              = b.input_field :head_position
              = b.error :head_position

          .field-group
            %h5.title Учредитель
            = b.fields_for :founder do |bf|
              .field-horizontal
                .field
                  %label Имя учредитель
                  = bf.input_field :name
                  = bf.error :name
                .field
                  %label Доля в компании
                  = bf.input_field :share
                  = bf.error :share
              .field.long
                %label Паспортные данные ОГРН
                = bf.input_field :pass_data_ogrn
                = bf.error :pass_data_ogrn

          .field-group
            %h5.title Основной банковский счет

            = b.fields_for :bank_account do |ba|
              .field-horizontal
                .field
                  %label Номер счета
                  = ba.input_field :account_number
                  = ba.error :account_number

                = ba.fields_for :bank do |bank|
                  .field
                    %label Бик
                    = bank.input_field :bik
                    = bank.error :bik
                  .field-horizontal
                    .field
                      %label Коррсчет
                      = bank.input_field :korr_number
                      = bank.error :korr_number
                    .field
                      %label ИНН
                      = bank.input_field :inn
                      = bank.error :inn
                  .field-horizontal
                    .field
                      %label Наименование банка
                      = bank.input_field :name
                      = bank.error :name
                    .field
                      %label Город
                      = bank.input_field :city
                      = bank.error :city
                  .field.long
                    %label Адрес
                    = bank.input_field :address
                    = bank.error :address

          .field-group
            %h5.title Персональные данные заемщика

            = b.fields_for :person do |p|
              .field-horizontal
                .field
                  %label ФИО
                  = p.input_field :fullname
                  = p.error :fullname
                .field
                  %label Дата рождения
                  = p.date_field :birthday
                  = p.error :birthday
              .field.long
                %label Место рождения
                = p.input_field :birth_place
                = p.error :birth_place
              .field.long
                %label Место регистрации
                = p.input_field :reg_place
                = p.error :reg_place
              .field.long
                %label Место пребывания
                = p.input_field :curr_place
                = p.error :curr_place
              .field
                %label Гражданство
                = p.input_field :citizenship
                = p.error :citizenship
              .field-horizontal
                .field
                  %label Телефон
                  = p.input_field :phone
                  = p.error :phone
                .field
                  %label E-mail
                  = p.input_field :email
                  = p.error :email

              .sub-group
                %h5.title Паспортные данные

                .field
                  %label Серия и номер паспорта
                  = p.input_field :pass_serial_number
                  = p.error :pass_serial_number

                .field.long
                  %label Кем выдан
                  = p.input_field :pass_issued
                  = p.error :pass_issued
                .field-horizontal
                  .field
                    %label Код подразделения
                    = p.input_field :pass_issued_code
                    = p.error :pass_issued_code

                  .field
                    %label Дата выдачи
                    = p.date_field :pass_issue_date
                    = p.error :pass_issue_date



                .sub-group
                  %h5.title Данные о ранее выданных паспортах

                  .field
                    %label Серия и номер паспорта
                    = p.input_field :old_pass_serial_number
                    = p.error :old_pass_serial_number

                  .field.long
                    %label Кем выдан
                    = p.input_field :old_pass_issued
                    = p.error :old_pass_issued
                  .field-horizontal
                    .field
                      %label Код подразделения
                      = p.input_field :old_pass_issued_code
                      = p.error :old_pass_issued_code

                    .field
                      %label Дата выдачи
                      = p.date_field :old_pass_issue_date
                      = p.error :old_pass_issue_date

      -# ПОРУЧИТЕЛИ #

      .tab-pane.fade{id:"guarantors"}
        = simple_fields_for :service do |s|
          .field.radio-group
            %label Выберите тип поручителя
            = s.collection_radio_buttons :guarantor_type, [['guarantor_individual', 'Физическое лицо'], ['guarantor_legal', 'Юридическое лицо']], :first, :last,
            checked: params[:service] ? params[:service][:guarantor_type] : 'guarantor_individual'

        -# ПОРУЧИТЕЛИ ФИЗИЧЕСКОЕ ЛИЦО #
        .guarantor{class:"guarantor_individual #{'hidden' if (params[:service] && params[:service][:guarantor_type] == 'guarantor_legal') || false}"}
          = render partial: 'shared/guarantor_individual_edit', locals: {f:f}

        -# ПОРУЧИТЕЛЬ ЮРИДИЧЕСКОЕ ЛИЦО #
        .guarantor{class:"guarantor_legal #{ 'hidden' if (params[:service] && params[:service][:guarantor_type] == 'guarantor_individual') || true}"}
          = render partial: 'shared/guarantor_legal_edit', locals:{f:f}


      .tab-pane.fade{ id:"documents" }
        = render partial: 'shared/order_documents', locals:{f:f}


      .field-submit
        = simple_fields_for :service do |s|
          = s.hidden_field :send_mfo, value: false
        = submit_tag "Сохранить", class:'btn btn-primary'


%script
  window.tarifs =
  =raw @tarifs.to_json